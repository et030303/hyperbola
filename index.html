<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒê³¡ì„ ì˜ ëª¨ë“  ê²ƒ by ET</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f8f9fa; font-family: 'Pretendard', sans-serif; }
        #header { position: absolute; top: 0; width: 100%; background: #1a1a2e; color: white; text-align: center; padding: 12px 0; font-size: 24px; font-weight: 800; z-index: 1002; letter-spacing: 1px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #header span { color: #ff4d4d; font-size: 16px; font-weight: normal; margin-left: 8px; }
        #menu { position: absolute; top: 52px; width: 100%; display: flex; justify-content: center; background: rgba(255, 255, 255, 0.95); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; color: #555; transition: 0.3s; }
        .tab.active { border-bottom: 3px solid #ff4d4d; color: #ff4d4d; }
        #ui-layer { position: absolute; top: 120px; left: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .ui-item { display: flex; align-items: center; gap: 8px; }
        .ui-item label { font-size: 14px; font-weight: bold; color: #333; min-width: 90px; }
        button { padding: 10px 15px; background: #ff4d4d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button.reset { background: #666; margin-top: 5px; }
        button.switch { background: #ff4d4d; display: none; }
        #angleUi { display: none; align-items: center; background: white; padding: 10px; border-radius: 8px; font-weight: bold; border: 2px solid #ff4d4d; }
        #infoBox { display: none; position: absolute; top: 120px; right: 20px; width: 300px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 1001; }
        #instructions { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; z-index: 1001; text-align: center; }
    </style>
</head>
<body>

<div id="header">ìŒê³¡ì„ ì˜ ëª¨ë“  ê²ƒ<span>by ET</span></div>

<div id="menu">
    <div id="tab1" class="tab active" onclick="setMode(1)">1. ìì·¨ ì‘ë„</div>
    <div id="tab2" class="tab" onclick="setMode(2)">2. ì •ì˜ í•™ìŠµ</div>
    <div id="tab3" class="tab" onclick="setMode(3)">3. ê´‘í•™ ì„±ì§ˆ</div>
</div>

<div id="ui-layer">
    <div class="ui-item">
        <label>ì´ˆì  ê±°ë¦¬ (2c):</label>
        <input type="range" id="cSlider" min="200" max="500" value="300" step="10">
        <span id="cValue">300</span>
    </div>
    <div class="ui-item">
        <label>ê±°ë¦¬ì˜ ì°¨ (2a):</label>
        <input type="range" id="aSlider" min="50" max="250" value="150" step="10">
        <span id="aValue">150</span>
    </div>
    <button class="reset" onclick="resetData()">ë°ì´í„° ì´ˆê¸°í™”</button>
    <button id="lightSwitchBtn" class="switch" onclick="toggleLightSource()">ğŸ’¡ ê´‘ì›: Fâ‚ (Red)</button>
    <label id="angleUi"><input type="checkbox" id="angleCheck" checked> ì…ì‚¬ê° / ë°˜ì‚¬ê° ë³´ê¸°</label>
    <button onclick="toggleInfo()">ğŸ“– ê°œë… ì„¤ëª…</button>
</div>

<div id="infoBox"></div>
<div id="instructions"></div>

<script>
    let mode = 1;
    let zoom = 1.0, offsetX = 0, offsetY = 0;
    let a = 75, c = 150;
    let tracePoints = [];
    let rays = [];
    let activeLightSource = 1;
    let isInfoOpen = false;

    function setup() {
        createCanvas(windowWidth, windowHeight);
        let cs = select('#cSlider'), as = select('#aSlider');
        cs.input(() => { 
            c = cs.value()/2; select('#cValue').html(cs.value()); 
            if(a >= c) { a = c-10; as.value(a*2); select('#aValue').html(a*2); }
            resetData(); 
        });
        as.input(() => { 
            a = as.value()/2; select('#aValue').html(as.value()); 
            if(a >= c) { c = a+10; cs.value(c*2); select('#cValue').html(c*2); }
            resetData(); 
        });
        updateInstruction();
    }

    function draw() {
        background(255);
        push();
        translate(width/2 + offsetX, height/2 + offsetY);
        scale(zoom);
        drawGrid();
        if (mode === 1) runMode1();
        else if (mode === 2) runMode2();
        else if (mode === 3) runMode3();
        pop();
    }

    function drawSubText(m, s, x, y, size, col) {
        push(); fill(col || 0); noStroke(); textSize(size);
        let w = textWidth(m); textAlign(LEFT, BASELINE);
        text(m, x - w/2, y); textSize(size * 0.7); text(s, x + w/2, y + size * 0.2);
        pop();
    }

    function runMode1() {
        let b = sqrt(c*c - a*a);
        let mx = (mouseX - width/2 - offsetX) / zoom;
        let my = (mouseY - height/2 - offsetY) / zoom;

        fill(0, 100, 255); ellipse(-c, 0, 12/zoom); ellipse(c, 0, 12/zoom);
        drawSubText("F", "1", -c, -15/zoom, 16/zoom);
        drawSubText("F", "2", c, -15/zoom, 16/zoom);

        if (mouseIsPressed && !isOverUI()) {
            let d1 = dist(mx, my, -c, 0);
            let d2 = dist(mx, my, c, 0);
            let diff = abs(d1 - d2);
            
            // ê±°ë¦¬ì˜ ì°¨ê°€ 2a ê·¼ì²˜ì¼ ë•Œë§Œ ì ì„ ì°ê³  ì„ ì„ ì—°ê²° (ê°€ìš´ë° ê°€ë¡œì§€ë¦„ ë°©ì§€)
            if (abs(diff - 2*a) < 20) {
                let ang = atan2(my, mx);
                let hypA = (mx > 0) ? a : -a;
                // ìŒê³¡ì„  ê³µì‹ ì—­ì‚°í•˜ì—¬ ì •ë°€í•œ ìœ„ì¹˜ ë³´ì •
                let px = mx; let py = my;
                tracePoints.push({x: px, y: py, side: (mx > 0 ? 1 : -1)});
                
                stroke(200); strokeWeight(2/zoom);
                line(-c, 0, px, py); line(c, 0, px, py);
                fill(0); textSize(14/zoom);
                text(`|d1-d2| â‰ˆ ${(diff).toFixed(1)}`, px, py - 20/zoom);
            }
        }

        noFill(); stroke(255, 77, 77); strokeWeight(3/zoom);
        beginShape(POINTS);
        for (let p of tracePoints) vertex(p.x, p.y);
        endShape();
    }

    function runMode2() {
        let b = sqrt(c*c - a*a);
        let mx = (mouseX - width/2 - offsetX) / zoom;
        let my = (mouseY - height/2 - offsetY) / zoom;

        // ì ê·¼ì„ 
        stroke(200, 200, 200, 150); strokeWeight(1/zoom);
        line(-width/zoom, -width/zoom * (b/a), width/zoom, width/zoom * (b/a));
        line(-width/zoom, width/zoom * (b/a), width/zoom, -width/zoom * (b/a));

        // ìŒê³¡ì„  ê·¸ë¦¬ê¸°
        noFill(); stroke(150); strokeWeight(2/zoom);
        for(let s of [-1, 1]) {
            beginShape();
            for(let t = -2; t <= 2; t += 0.1) {
                vertex(s * a * cosh(t), b * sinh(t));
            }
            endShape();
        }

        let items = [
            {x: 0, y: 0, label: "ì¤‘ì‹¬"},
            {x: -c, y: 0, label: "ì´ˆì  F1"},
            {x: c, y: 0, label: "ì´ˆì  F2"}
        ];

        let hovered = items.find(i => dist(mx, my, i.x, i.y) < 20/zoom);
        
        fill(0, 122, 255); ellipse(-c, 0, 12/zoom); ellipse(c, 0, 12/zoom);
        fill(0); ellipse(0, 0, 8/zoom);

        if (hovered) {
            fill(255, 200, 0, 150); noStroke(); ellipse(hovered.x, hovered.y, 40/zoom);
            fill(0); textAlign(CENTER); text(hovered.label, hovered.x, hovered.y - 25/zoom);
        }

        // ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ ê±°ë¦¬ ì°¨ ì¸¡ì •
        if (mouseIsPressed && !isOverUI()) {
            let side = mx > 0 ? 1 : -1;
            let ang = atan2(my, abs(mx));
            let t = log(abs(mx/a) + sqrt(pow(mx/a, 2) - 1)) || 0;
            if (isNaN(t)) t = 0;
            let px = side * a * cosh(t);
            let py = (my > 0 ? 1 : -1) * b * sinh(t);
            
            let d1 = dist(px, py, -c, 0);
            let d2 = dist(px, py, c, 0);
            stroke(34, 197, 94); line(-c, 0, px, py); line(c, 0, px, py);
            fill(34, 197, 94); ellipse(px, py, 10/zoom);
            fill(0); text(`ì°¨ì´: ${abs(d1-d2).toFixed(1)} (2a)`, px, py - 20/zoom);
        }
    }

    function runMode3() {
        let b = sqrt(c*c - a*a);
        let mx = (mouseX - width/2 - offsetX) / zoom;
        let my = (mouseY - height/2 - offsetY) / zoom;

        noFill(); stroke(200); strokeWeight(2/zoom);
        for(let s of [-1, 1]) {
            beginShape();
            for(let t = -2.5; t <= 2.5; t += 0.1) vertex(s * a * cosh(t), b * sinh(t));
            endShape();
        }

        let srcX = activeLightSource === 1 ? -c : c;
        let targetX = activeLightSource === 1 ? c : -c;
        let themeCol = activeLightSource === 1 ? color(255, 0, 0) : color(0, 100, 255);

        fill(themeCol); ellipse(srcX, 0, 15/zoom);
        fill(150); ellipse(targetX, 0, 10/zoom);

        if (mouseIsPressed && !isOverUI()) {
            if (frameCount % 5 === 0) {
                // í•œ ì´ˆì ì—ì„œ ë‹¤ë¥¸ ì´ˆì ì„ í–¥í•´ ì˜ëŠ” ê´‘ì„ 
                let dir = createVector(mx - srcX, my).normalize();
                let t = solveHyperbola(srcX, 0, dir.x, dir.y, a, b);
                if (t > 0) {
                    let hitX = srcX + dir.x * t;
                    let hitY = dir.y * t;
                    // ë°˜ì‚¬ê´‘ì€ ë‹¤ë¥¸ ì´ˆì (targetX)ì—ì„œ ë»—ì–´ë‚˜ì˜¤ëŠ” ë°©í–¥
                    let refDir = createVector(hitX - targetX, hitY).normalize();
                    rays.push({px: srcX, py: 0, hx: hitX, hy: hitY, rx: hitX + refDir.x*1000, ry: hitY + refDir.y*1000, life: 255, col: themeCol});
                }
            }
        }

        for (let i = rays.length - 1; i >= 0; i--) {
            let r = rays[i];
            stroke(r.col.levels[0], r.col.levels[1], r.col.levels[2], r.life);
            line(r.px, r.py, r.hx, r.hy);
            line(r.hx, r.hy, r.rx, r.ry);
            r.life -= 5;
            if (r.life <= 0) rays.splice(i, 1);
        }
    }

    function solveHyperbola(sx, sy, dx, dy, a, b) {
        let A = (dx*dx)/(a*a) - (dy*dy)/(b*b);
        let B = 2*sx*dx/(a*a) - 2*sy*dy/(b*b);
        let C = (sx*sx)/(a*a) - (sy*sy)/(b*b) - 1;
        let det = B*B - 4*A*C;
        if (det < 0) return -1;
        let t1 = (-B + sqrt(det))/(2*A);
        let t2 = (-B - sqrt(det))/(2*A);
        return t1 > 0.1 ? t1 : t2;
    }

    function toggleLightSource() {
        activeLightSource = activeLightSource === 1 ? 2 : 1;
        let btn = document.getElementById('lightSwitchBtn');
        if(activeLightSource === 1) {
            btn.innerHTML = "ğŸ’¡ ê´‘ì›: Fâ‚ (Red)";
            btn.style.background = "#ff4d4d";
        } else {
            btn.innerHTML = "ğŸ’¡ ê´‘ì›: Fâ‚‚ (Blue)";
            btn.style.background = "#007bff";
        }
        rays = [];
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i+1 === m));
        document.getElementById('lightSwitchBtn').style.display = m === 3 ? 'block' : 'none';
        document.getElementById('angleUi').style.display = m === 3 ? 'flex' : 'none';
        resetData();
        updateInstruction();
    }

    function updateInstruction() {
        let ins = document.getElementById('instructions');
        if(mode===1) ins.innerHTML = "ì´ˆì  ë°”ê¹¥ìª½ì—ì„œ ë§ˆìš°ìŠ¤ë¥¼ ì›€ì§ì—¬ ìŒê³¡ì„ ì„ ê·¸ë ¤ë³´ì„¸ìš”.";
        else if(mode===2) ins.innerHTML = "ì¤‘ì‹¬ê³¼ ì´ˆì ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ê±°ë‚˜, ê³¡ì„  ìœ„ë¥¼ í´ë¦­í•´ë³´ì„¸ìš”.";
        else ins.innerHTML = "ê´‘ì›(F)ì—ì„œ ë°˜ëŒ€í¸ ì´ˆì ì„ í–¥í•´ ë¹›ì„ ì˜ë©´ ê³¡ì„ ì— ë°˜ì‚¬ë©ë‹ˆë‹¤.";
    }

    function resetData() { tracePoints = []; rays = []; }
    function cosh(x) { return (exp(x) + exp(-x)) / 2; }
    function sinh(x) { return (exp(x) - exp(-x)) / 2; }
    function isOverUI() { return mouseX < 280 && mouseY > 100 && mouseY < 400; }
    function drawGrid() { stroke(240); for(let i=-2000; i<2000; i+=50) { line(i,-2000,i,2000); line(-2000,i,2000,i); } }
    function windowResized() { resizeCanvas(windowWidth, windowHeight); }
    function toggleInfo() { isInfoOpen = !isInfoOpen; document.getElementById('infoBox').style.display = isInfoOpen ? 'block' : 'none'; document.getElementById('infoBox').innerHTML = "<h3>ìŒê³¡ì„ ì˜ ì„±ì§ˆ</h3>ë‘ ì´ˆì ìœ¼ë¡œë¶€í„°ì˜ <b>ê±°ë¦¬ì˜ ì°¨</b>ê°€ ì¼ì •í•œ ì ë“¤ì˜ ì§‘í•©ì…ë‹ˆë‹¤. ê´‘í•™ì ìœ¼ë¡œ í•œ ì´ˆì ì„ í–¥í•´ ë‚˜ì•„ê°€ëŠ” ë¹›ì€ ìŒê³¡ì„  ê±°ìš¸ì— ë°˜ì‚¬ë˜ì–´ ë‹¤ë¥¸ ì´ˆì ì—ì„œ ë‚˜ì˜¤ëŠ” ê²ƒì²˜ëŸ¼ ë‚˜ì•„ê°‘ë‹ˆë‹¤."; }
</script>
</body>
</html>
